<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quantile additive models using qgam and mgcViz • mgcViz</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Quantile additive models using qgam and mgcViz">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mgcViz</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/BayesPost.html">Bayesian posterior simulations and predictive checks</a>
    </li>
    <li>
      <a href="../articles/mgcviz.html">An introduction to mgcViz: visual tools for GAMs</a>
    </li>
    <li>
      <a href="../articles/miscellanea.html">Miscellanea: things you can do in mgcViz</a>
    </li>
    <li>
      <a href="../articles/qgam_mgcViz.html">Quantile additive models using qgam and mgcViz</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mfasiolo/mgcViz">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Quantile additive models using qgam and mgcViz</h1>
                        <h4 class="author">Matteo Fasiolo and Raphael Nedellec</h4>
            
            <h4 class="date">March 04 2020</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/mfasiolo/mgcViz/blob/master/vignettes/qgam_mgcViz.Rmd"><code>vignettes/qgam_mgcViz.Rmd</code></a></small>
      <div class="hidden name"><code>qgam_mgcViz.Rmd</code></div>

    </div>

    
    
<style>
body {
text-align: justify}
</style>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>The <code>qgam</code> R package offers methods for fitting additive quantile regression models based on splines, using the methods described in <a href="https://arxiv.org/abs/1707.03307">Fasiolo et al., 2017</a>. It is useful to use <code>qgam</code> together with <code>mgcViz</code> <a href="https://arxiv.org/abs/1809.10632">Fasiolo et al., 2018</a>, which extends the basic visualizations provided by <code>mgcv</code>.</p>
<p>The main fitting functions are:</p>
<ul>
<li>
<code>qgam()</code> fits an additive quantile regression model to a single quantile. Very similar to <code><a href="https://rdrr.io/pkg/mgcv/man/gam.html">mgcv::gam()</a></code>. It returns an object of class <code>qgam</code>, which inherits from <code><a href="https://rdrr.io/pkg/mgcv/man/gamObject.html">mgcv::gamObject</a></code>.</li>
<li>
<code>mqgam()</code> fits the same additive quantile regression model to several quantiles. It is more efficient that calling <code>qgam()</code> several times, especially in terms of memory usage.</li>
<li>
<code><a href="../reference/qgamV.html">qgamV()</a></code> and <code><a href="../reference/mqgamV.html">mqgamV()</a></code> are two convenient wrappers that fit quantile GAMs and return <code>gamViz</code> objects, for which <code>mgcViz</code> provides lots of visualizations.</li>
</ul>
</div>
<div id="an-additive-example-with-four-covariates" class="section level1">
<h1 class="hasAnchor">
<a href="#an-additive-example-with-four-covariates" class="anchor"></a>An additive example with four covariates</h1>
<p>We simulate some data from the model: <span class="math display">\[
y = f_0(x_0)+f_1(x_1)+f_2(x_2)+f_3(x_3)+e,\;\;\; e \sim N(0, 2)
\]</span> by doing</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(mgcViz)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">dat &lt;-<span class="st"> </span><span class="kw">gamSim</span>(<span class="dv">1</span>, <span class="dt">n=</span><span class="dv">1000</span>, <span class="dt">dist=</span><span class="st">"normal"</span>, <span class="dt">scale=</span><span class="dv">2</span>)[<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"y"</span>, <span class="st">"x0"</span>, <span class="st">"x1"</span>, <span class="st">"x2"</span>, <span class="st">"x3"</span>)]</a></code></pre></div>
<pre><code>## Gu &amp; Wahba 4 term additive model</code></pre>
<p>We start by fitting a linear quantile model for the median:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">fit1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qgamV.html">qgamV</a></span>(y <span class="op">~</span><span class="st"> </span>x0 <span class="op">+</span><span class="st"> </span>x1 <span class="op">+</span><span class="st"> </span>x2 <span class="op">+</span><span class="st"> </span>x3, <span class="dt">data=</span>dat, <span class="dt">qu =</span> <span class="fl">0.5</span>)</a></code></pre></div>
<pre><code>## Estimating learning rate. Each dot corresponds to a loss evaluation. 
## qu = 0.5.......done</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(fit1, <span class="dt">allTerms =</span> <span class="ot">TRUE</span>), <span class="dt">pages =</span> <span class="dv">1</span>)</a></code></pre></div>
<p><img src="qgam_mgcViz_files/figure-html/fourD2-1.png" width="700" style="display:block; margin: auto"> We use <code>pages = 1</code> to plot on a single page, and <code>allTerms</code> to plot also the parametric effects (the plotting method used here plots only smooth or random effects by default).</p>
<p>Should we use a smooth effect of <code>x0</code>? If the effect of <code>x0</code> was non-linear, we would expect that the number of observations falling below the fit would depart from 0.5, as we move along <code>x0</code>. A rudimental diagnostic plot is:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(dat<span class="op">$</span>x0, <span class="kw"><a href="https://rdrr.io/r/base/sign.html">sign</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(fit1)) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(dat), <span class="dv">0</span>, <span class="fl">0.05</span>), <span class="dt">col =</span> <span class="kw">alpha</span>(<span class="dv">1</span>, <span class="fl">0.4</span>), <span class="dt">pch =</span> <span class="dv">16</span>,</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">     <span class="dt">ylab =</span> <span class="st">"Residuals sign"</span>, <span class="dt">xlab =</span> <span class="st">"x0"</span>)</a></code></pre></div>
<p><img src="qgam_mgcViz_files/figure-html/fourD3a-1.png" width="700" style="display:block; margin: auto"> But residual pattern is more visible in the following plot:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw"><a href="../reference/check1D.html">check1D</a></span>(fit1, <span class="st">"x0"</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="../reference/l_gridQCheck1D.html">l_gridQCheck1D</a></span>(<span class="dt">qu =</span> <span class="fl">0.5</span>)</a></code></pre></div>
<p><img src="qgam_mgcViz_files/figure-html/fourD3-1.png" width="700" style="display:block; margin: auto"> There is definitely a pattern here. An analogous plot along <code>x2</code> also shows a residual pattern, hence we consider the model:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">fit2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qgamV.html">qgamV</a></span>(y <span class="op">~</span><span class="st"> </span><span class="kw">s</span>(x0) <span class="op">+</span><span class="st"> </span>x1 <span class="op">+</span><span class="st"> </span><span class="kw">s</span>(x2) <span class="op">+</span><span class="st"> </span>x3, <span class="dt">data=</span>dat, <span class="dt">qu =</span> <span class="fl">0.5</span>)</a></code></pre></div>
<pre><code>## Estimating learning rate. Each dot corresponds to a loss evaluation. 
## qu = 0.5.......done</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="../reference/check1D.html">check1D</a></span>(fit2, <span class="st">"x0"</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="../reference/l_gridQCheck1D.html">l_gridQCheck1D</a></span>(<span class="dt">qu =</span> <span class="fl">0.5</span>)</a></code></pre></div>
<p><img src="qgam_mgcViz_files/figure-html/fourD4-1.png" width="700" style="display:block; margin: auto"> Looks much better, and leads to much lower AIC:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/stats/AIC.html">AIC</a></span>(fit1) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/AIC.html">AIC</a></span>(fit2)</a></code></pre></div>
<pre><code>## [1] 764.418</code></pre>
<p>We can plot all the smooth effects by doing:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(fit2), <span class="dt">pages =</span> <span class="dv">1</span>)</a></code></pre></div>
<p><img src="qgam_mgcViz_files/figure-html/fourD5-1.png" width="576" style="display:block; margin: auto"> To print only the second we do</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(fit2, <span class="dt">select =</span> <span class="dv">2</span>), <span class="dt">pages =</span> <span class="dv">1</span>)</a></code></pre></div>
<p><img src="qgam_mgcViz_files/figure-html/fourD6-1.png" width="700" style="display:block; margin: auto"></p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(fit2, <span class="dt">allTerms =</span> <span class="ot">TRUE</span>), <span class="dt">pages =</span> <span class="dv">1</span>)</a></code></pre></div>
<p><img src="qgam_mgcViz_files/figure-html/fourD7-1.png" width="700" style="display:block; margin: auto"> Now we fit this model to multiple quantiles and plot the fitted effects:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mqgamV.html">mqgamV</a></span>(y <span class="op">~</span><span class="st"> </span><span class="kw">s</span>(x0) <span class="op">+</span><span class="st"> </span>x1 <span class="op">+</span><span class="st"> </span><span class="kw">s</span>(x2) <span class="op">+</span><span class="st"> </span>x3, <span class="dt">data=</span>dat,</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">              <span class="dt">qu =</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0.1</span>, <span class="fl">0.9</span>, <span class="dt">length.out =</span> <span class="dv">5</span>))</a></code></pre></div>
<pre><code>## Estimating learning rate. Each dot corresponds to a loss evaluation. 
## qu = 0.5.......done 
## qu = 0.3.......done 
## qu = 0.7........done 
## qu = 0.1........done 
## qu = 0.9........done</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(fit, <span class="dt">allTerms =</span> <span class="ot">TRUE</span>), <span class="dt">pages =</span> <span class="dv">1</span>)</a></code></pre></div>
<p><img src="qgam_mgcViz_files/figure-html/fourD8-1.png" width="700" style="display:block; margin: auto"></p>
<p>We can manipulate the five fitted quantile GAMs individually, for example</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(fit[[<span class="dv">1</span>]], <span class="dt">allTerms =</span> <span class="ot">TRUE</span>), <span class="dt">pages =</span> <span class="dv">1</span>)</a></code></pre></div>
<p><img src="qgam_mgcViz_files/figure-html/fourD9-1.png" width="700" style="display:block; margin: auto"></p>
</div>
<div id="random-effect-modelling-lexical-decision-task" class="section level1">
<h1 class="hasAnchor">
<a href="#random-effect-modelling-lexical-decision-task" class="anchor"></a>Random effect modelling: lexical decision task</h1>
<p>In this experiment participants are presented with a sequence of stimuli and they have to decide, as quickly as possible, whether each stimulus is an existing words (eg. house) or a non-existing word (eg. pensour) by pressing one of two buttons. The variables we consider here are:</p>
<ul>
<li>
<code>RT</code> logarithmically transformed reaction time.</li>
<li>
<code>NativeLanguage</code> a factor with levels English and Other.</li>
<li>
<code>Length</code> the word’s length in letters.</li>
<li>
<code>Frequency</code> logarithmically transformed lemma frequencies as available in the CELEX lexical database.</li>
<li>
<code>Subject</code> the id of the individual subjects.</li>
<li>
<code>Trial</code> the rank of the trial in the experimental list.</li>
<li>
<code>Word</code> a factor with 79 words as levels.</li>
</ul>
<p>We might be interested in modeling the relation between the response time and length, frequency, native language and trial, and we might want to control for word and subject. We start by loading the data and fitting a simple QGAM model for the median:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(languageR)</a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(lexdec)</a>
<a class="sourceLine" id="cb20-3" data-line-number="3"></a>
<a class="sourceLine" id="cb20-4" data-line-number="4">lexdec<span class="op">$</span>RT0 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>( lexdec<span class="op">$</span>RT ) <span class="co"># Should not need to use log-responses to normalize</span></a>
<a class="sourceLine" id="cb20-5" data-line-number="5"></a>
<a class="sourceLine" id="cb20-6" data-line-number="6">fit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qgamV.html">qgamV</a></span>(RT0 <span class="op">~</span><span class="st"> </span><span class="kw">s</span>(Trial) <span class="op">+</span><span class="st"> </span>NativeLanguage <span class="op">+</span><span class="st"> </span><span class="kw">s</span>(Length, <span class="dt">k =</span> <span class="dv">5</span>) <span class="op">+</span><span class="st"> </span><span class="kw">s</span>(Frequency),</a>
<a class="sourceLine" id="cb20-7" data-line-number="7">            <span class="dt">data =</span> lexdec, <span class="dt">qu =</span> <span class="fl">0.5</span>)</a></code></pre></div>
<pre><code>## Estimating learning rate. Each dot corresponds to a loss evaluation. 
## qu = 0.5.............done</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(fit), <span class="dt">pages =</span> <span class="dv">1</span>)</a></code></pre></div>
<p><img src="qgam_mgcViz_files/figure-html/lex1-1.png" width="700" style="display:block; margin: auto"> It is natural to ask ourselves whether we should control for <code>Subject</code> and for <code>Word</code>:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="co"># check1D(fit, "Subject") would not work because it was not included in the original fit</span></a>
<a class="sourceLine" id="cb23-2" data-line-number="2"><span class="kw"><a href="../reference/check1D.html">check1D</a></span>(fit, lexdec<span class="op">$</span>Subject) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="../reference/l_gridQCheck1D.html">l_gridQCheck1D</a></span>(<span class="dt">qu =</span> <span class="fl">0.5</span>)</a></code></pre></div>
<p><img src="qgam_mgcViz_files/figure-html/lex2-1.png" width="700" style="display:block; margin: auto"></p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="kw"><a href="../reference/check1D.html">check1D</a></span>(fit, lexdec<span class="op">$</span>Word) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="../reference/l_gridQCheck1D.html">l_gridQCheck1D</a></span>(<span class="dt">qu =</span> <span class="fl">0.5</span>)</a></code></pre></div>
<p><img src="qgam_mgcViz_files/figure-html/lex2-2.png" width="700" style="display:block; margin: auto"> It seems so, hence we refit using two random effects:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">fit2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qgamV.html">qgamV</a></span>(RT0 <span class="op">~</span><span class="st"> </span><span class="kw">s</span>(Trial) <span class="op">+</span><span class="st"> </span>NativeLanguage <span class="op">+</span><span class="st"> </span><span class="kw">s</span>(Length, <span class="dt">k =</span> <span class="dv">5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="st">                    </span><span class="kw">s</span>(Frequency) <span class="op">+</span><span class="st"> </span><span class="kw">s</span>(Subject, <span class="dt">bs =</span> <span class="st">"re"</span>) <span class="op">+</span><span class="st"> </span><span class="kw">s</span>(Word, <span class="dt">bs =</span> <span class="st">"re"</span>),</a>
<a class="sourceLine" id="cb25-3" data-line-number="3">            <span class="dt">data =</span> lexdec, <span class="dt">qu =</span> <span class="fl">0.5</span>)</a></code></pre></div>
<pre><code>## Estimating learning rate. Each dot corresponds to a loss evaluation. 
## qu = 0.5..........done</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="kw"><a href="../reference/check1D.html">check1D</a></span>(fit2, <span class="st">"Subject"</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="../reference/l_gridQCheck1D.html">l_gridQCheck1D</a></span>(<span class="dt">qu =</span> <span class="fl">0.5</span>)</a></code></pre></div>
<p><img src="qgam_mgcViz_files/figure-html/lex3-1.png" width="700" style="display:block; margin: auto"></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="kw"><a href="../reference/check1D.html">check1D</a></span>(fit2, <span class="st">"Word"</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="../reference/l_gridQCheck1D.html">l_gridQCheck1D</a></span>(<span class="dt">qu =</span> <span class="fl">0.5</span>)</a></code></pre></div>
<p><img src="qgam_mgcViz_files/figure-html/lex3-2.png" width="700" style="display:block; margin: auto"></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/stats/AIC.html">AIC</a></span>(fit) <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/AIC.html">AIC</a></span>(fit2)</a></code></pre></div>
<pre><code>## [1] 817.0046</code></pre>
<p>We achieve lower AIC and the residuals checks look better (especially the one for <code>Subject</code>).</p>
<p>A potentially interesting question is then: is the effect of <code>Trial</code> different for native and non-native speakers? We can verify this by using a by-factor smooth:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1">fit3 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/qgamV.html">qgamV</a></span>(RT0 <span class="op">~</span><span class="st">  </span><span class="kw">s</span>(Trial, <span class="dt">by =</span> NativeLanguage) <span class="op">+</span><span class="st"> </span><span class="co"># &lt;- by-factor smooth</span></a>
<a class="sourceLine" id="cb31-2" data-line-number="2"><span class="st">                    </span>NativeLanguage <span class="op">+</span><span class="st"> </span><span class="kw">s</span>(Length, <span class="dt">k =</span> <span class="dv">5</span>) <span class="op">+</span><span class="st"> </span><span class="kw">s</span>(Frequency) <span class="op">+</span></a>
<a class="sourceLine" id="cb31-3" data-line-number="3"><span class="st">                    </span><span class="kw">s</span>(Subject, <span class="dt">bs =</span> <span class="st">"re"</span>) <span class="op">+</span><span class="st"> </span><span class="kw">s</span>(Word, <span class="dt">bs =</span> <span class="st">"re"</span>),</a>
<a class="sourceLine" id="cb31-4" data-line-number="4">             <span class="dt">data =</span> lexdec, <span class="dt">qu =</span> <span class="fl">0.5</span>)</a></code></pre></div>
<pre><code>## Estimating learning rate. Each dot corresponds to a loss evaluation. 
## qu = 0.5...........done</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(fit3), <span class="dt">pages =</span> <span class="dv">1</span>)</a></code></pre></div>
<p><img src="qgam_mgcViz_files/figure-html/lex4-1.png" width="700" style="display:block; margin: auto"> Can look directly at the difference between the by-factor smooths by doing:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1">s1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sm.html">sm</a></span>(fit3, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb34-2" data-line-number="2">s2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sm.html">sm</a></span>(fit3, <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb34-3" data-line-number="3"><span class="kw"><a href="../reference/plotDiff.html">plotDiff</a></span>(s1, s2) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="../reference/l_ciPoly.html">l_ciPoly</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="../reference/l_fitLine.html">l_fitLine</a></span>()</a></code></pre></div>
<p><img src="qgam_mgcViz_files/figure-html/lex5-1.png" width="700" style="display:block; margin: auto"> There might be something there, but the difference is not very strong.</p>
<p>Now that we have converged on a (hopefully reasonable) model, we can fit it to several quantiles:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1">fit5 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mqgamV.html">mqgamV</a></span>(RT0 <span class="op">~</span><span class="st"> </span><span class="kw">s</span>(Trial, <span class="dt">by =</span> NativeLanguage) <span class="op">+</span><span class="st"> </span>NativeLanguage <span class="op">+</span><span class="st"> </span><span class="kw">s</span>(Length, <span class="dt">k =</span> <span class="dv">5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb35-2" data-line-number="2"><span class="st">                </span><span class="op">+</span><span class="st"> </span><span class="kw">s</span>(Frequency) <span class="op">+</span><span class="st"> </span><span class="kw">s</span>(Subject, <span class="dt">bs =</span> <span class="st">"re"</span>) <span class="op">+</span><span class="st"> </span><span class="kw">s</span>(Word, <span class="dt">bs =</span> <span class="st">"re"</span>),</a>
<a class="sourceLine" id="cb35-3" data-line-number="3">                <span class="dt">data =</span> lexdec, <span class="dt">qu =</span> <span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>, <span class="dt">length.out =</span> <span class="dv">5</span>))</a></code></pre></div>
<pre><code>## Estimating learning rate. Each dot corresponds to a loss evaluation. 
## qu = 0.5...........done 
## qu = 0.35...........done 
## qu = 0.65............done 
## qu = 0.2..............done 
## qu = 0.8...........done</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="https://rdrr.io/r/graphics/plot.html">plot</a></span>(fit5, <span class="dt">allTerms =</span> <span class="ot">TRUE</span>), <span class="dt">pages =</span> <span class="dv">2</span>, <span class="dt">ask =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<p><img src="qgam_mgcViz_files/figure-html/lex6-1.png" width="700" style="display:block; margin: auto"><img src="qgam_mgcViz_files/figure-html/lex6-2.png" width="700" style="display:block; margin: auto"> The effects are fairly stable across quantiles, the effect of <code>Frequency</code> might be stronger for high quantiles. We can examine the fitted quantile models individually:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(fit5[[<span class="dv">5</span>]])</a></code></pre></div>
<pre><code>## 
## Family: elf 
## Link function: identity 
## 
## Formula:
## RT0 ~ s(Trial, by = NativeLanguage) + NativeLanguage + s(Length, 
##     k = 5) + +s(Frequency) + s(Subject, bs = "re") + s(Word, 
##     bs = "re")
## 
## Parametric coefficients:
##                     Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)           641.78      31.08   20.65   &lt;2e-16 ***
## NativeLanguageOther   119.27      46.95    2.54   0.0111 *  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Approximate significance of smooth terms:
##                                   edf Ref.df  Chi.sq  p-value    
## s(Trial):NativeLanguageEnglish  2.679  3.320  13.162  0.00732 ** 
## s(Trial):NativeLanguageOther    1.375  1.653   0.472  0.59694    
## s(Length)                       1.007  1.009   1.108  0.29424    
## s(Frequency)                    2.793  3.036  35.087 1.37e-07 ***
## s(Subject)                     18.556 19.000 832.680  &lt; 2e-16 ***
## s(Word)                        48.808 76.000 170.439 4.60e-09 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## R-sq.(adj) =  0.444   Deviance explained = 52.9%
## -REML =  10717  Scale est. = 1         n = 1659</code></pre>
</div>
<div id="references" class="section level1">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<ul>
<li><p>Fasiolo, M., Goude, Y., Nedellec, R. and Wood, S. N. (2017). Fast calibrated additive quantile regression. Available at <a href="https://arxiv.org/abs/1707.03307" class="uri">https://arxiv.org/abs/1707.03307</a></p></li>
<li><p>Fasiolo, M., Nedellec, R., Goude, Y. and Wood, S.N. (2018). Scalable visualisation methods for modern Generalized Additive Models. arXiv preprint arXiv:1809.10632.</p></li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#an-additive-example-with-four-covariates">An additive example with four covariates</a></li>
      <li><a href="#random-effect-modelling-lexical-decision-task">Random effect modelling: lexical decision task</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Matteo Fasiolo, Raphael Nedellec.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
